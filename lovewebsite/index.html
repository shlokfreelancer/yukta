[Immersive content redacted for brevity.]<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For My Shinchan üíñ</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. three.js for 3D background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- 3. Tone.js for generative music -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Playwrite+IN:wght@100..400&family=Dancing+Script:wght@400..700&display=swap');

        body {
            font-family: 'Playwrite IN', 'Dancing Script', cursive;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 3D Canvas */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6;
        }

        /* Screen transitions */
        .screen {
            transition: opacity 0.7s ease-in-out, transform 0.7s ease-in-out;
        }

        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }

        /* Chat bubbles */
        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .chat-bot {
            background-color: #e11d48; /* Rose-700 */
            color: white;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        .chat-user {
            background-color: #374151; /* Gray-700 */
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        
        .chat-options button {
            transition: all 0.3s ease;
        }
        
        .chat-options button:hover {
            transform: scale(1.05);
            background-color: #f43f5e; /* Rose-500 */
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.3s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Hand animation */
        #hand-svg {
            width: 100px;
            height: 100px;
            animation: reach 2s ease-in-out infinite;
        }

        @keyframes reach {
            0%, 100% { transform: scale(1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        /* Heart animation */
        .heart {
            position: absolute;
            font-size: 2rem;
            opacity: 0;
            animation: floatUp 5s ease-in infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        /* Pop-in animation for chat */
        @keyframes popIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">
    <!-- 3D Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Mute Button -->
    <button id="mute-button" class="fixed top-4 right-4 z-50 bg-rose-600 p-2 rounded-full text-white shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-unmuted">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-muted" class="hidden">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="1" x2="1" y2="23"></line>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
    </button>
    
    <!-- Audio element removed - we are using Tone.js now -->

    <!-- Main Container -->
    <div class="relative w-full h-screen flex items-center justify-center p-4">

        <!-- === SCREEN 1: Name Prompt === -->
        <div id="name-prompt-screen" class="screen w-full max-w-md text-center">
            <h1 class="text-5xl font-bold text-rose-400 mb-6" style="font-family: 'Dancing Script', cursive;">Hello...</h1>
            <p class="text-xl text-gray-200 mb-8">Kya mai aapka naam jaan sakta hu? üíñ</p>
            <input type="text" id="name-input" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white text-center text-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Aapka pyara sa naam...">
            <button id="name-submit-btn" class="w-full mt-4 bg-rose-600 text-white p-3 rounded-lg text-lg font-semibold hover:bg-rose-700 transition-colors">Enter</button>
        </div>

        <!-- === SCREEN 2: Gatekeep === -->
        <div id="gatekeep-screen" class="screen hidden w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-yellow-400 mb-6">Bhag yaha se!</h1>
            <p class="text-2xl text-white mb-8">Ye website sirf meri Shinchan ke liye banai gayi hai üòúüíñ</p>
            <button id="try-again-btn" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-lg text-lg font-semibold hover:bg-gray-700 transition-colors">Try Again</button>
        </div>

        <!-- === SCREEN 3: Q&A === -->
        <div id="qa-screen" class="screen hidden w-full max-w-md h-[80vh] bg-gray-800 bg-opacity-70 backdrop-blur-sm rounded-2xl shadow-2xl flex flex-col">
            <header class="text-center p-4 border-b border-gray-700">
                <h2 class="text-2xl font-bold text-rose-400">My Shinchan's Choices</h2>
            </header>
            <div id="chat-container" class="flex-1 p-4 flex flex-col space-y-4 overflow-y-auto">
                <!-- Chat messages will be appended here -->
            </div>
            <div id="options-container" class="p-4 border-t border-gray-700 chat-options flex gap-3">
                <!-- Options will be appended here -->
            </div>
        </div>

        <!-- === SCREEN 4: Transition === -->
        <div id="transition-screen" class="screen hidden w-full max-w-md text-center flex flex-col items-center">
            <!-- Inline SVG for a reaching hand -->
            <svg id="hand-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.49 8.61998C17.49 8.61998 17.06 14.3 14.28 15.34C13.06 15.77 12.01 15.3 11.21 14.86C10.41 14.42 9.25999 13.92 8.23999 14.86C7.21999 15.8 6.78 17.65 8.23999 19.38C9.69999 21.11 11.83 21.15 13.29 19.38C14.75 17.61 14.14 15.65 14.14 15.65M17.49 8.61998C17.49 8.61998 17.06 3.61998 15.3 2.70998C13.54 1.79998 11.96 3.10998 11.16 3.82998C10.36 4.54998 8.85 5.75998 8.04999 7.02998C7.24999 8.29998 7.42 10.15 8.78 11.23C10.14 12.31 11.85 12.18 13.11 11.23C14.37 10.28 15.42 8.75998 15.42 8.75998" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M11.21 14.86L10.97 12.48" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p class="text-2xl text-white mt-6 mb-8">Aap mere saath agle question pe chalna chahengi? üí´</p>
            <button id="next-q-btn" class="w-full bg-rose-600 text-white p-3 rounded-lg text-lg font-semibold hover:bg-rose-700 transition-colors">Chalo!</button>
        </div>
        
        <!-- === SCREEN 5: Final SRK === -->
        <div id="final-srk-screen" class="screen hidden w-full max-w-lg text-center">
            <div id="hearts-container" class="absolute inset-0 z-0"></div>
            <div class="relative z-10 p-6 bg-black bg-opacity-50 rounded-2xl">
                <h1 class="text-4xl font-bold text-rose-400 mb-6" style="font-family: 'Dancing Script', cursive;">Yukta...</h1>
                <p class="text-2xl text-gray-100 leading-relaxed mb-4">tum bas naam nahi ehsaas ho,</p>
                <p class="text-2xl text-gray-100 leading-relaxed mb-4">tum vo muskaan ho jo din bana de üí´</p>
                <p class="text-2xl text-gray-100 leading-relaxed mb-8">Tum vo magic ho, jisse dekhe bina dil nahi lagta üíñ</p>
                <button id="exit-btn" class="w-full bg-gray-700 text-white p-3 rounded-lg text-lg font-semibold hover:bg-gray-800 transition-colors">Exit</button>
            </div>
        </div>

        <!-- === SCREEN 6: Hate You === -->
        <div id="hate-you-screen" class="screen hidden w-full max-w-md text-center">
            <h1 class="text-6xl font-bold text-rose-500 mb-8">I hate u üò§</h1>
            <input type="text" id="hate-input" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white text-center text-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Reply...">
            <button id="hate-reply-btn" class="w-full mt-4 bg-rose-600 text-white p-3 rounded-lg text-lg font-semibold hover:bg-rose-700 transition-colors">Send</button>
        </div>

        <!-- === SCREEN 7: Final Reply === -->
        <div id="final-reply-screen" class="screen hidden w-full max-w-md text-center">
            <p class="text-3xl text-gray-100 leading-relaxed mb-6">Itna pyar ke liye aapka shukriya ‚ù§Ô∏è</p>
            <p class="text-3xl text-gray-100 leading-relaxed">Apna khayal rakhiye... nahi rakhenge to mai aa jaunga üòò</p>
        </div>

        <!-- === SCREEN 8: Final Image === -->
        <div id="final-image-screen" class="screen hidden w-full max-w-md text-center">
            <div id="image-loading" class="text-center">
                <p class="text-2xl text-rose-300 mb-4">Ek last cheez...</p>
                <div class="w-16 h-16 border-4 border-dashed border-rose-400 border-t-transparent rounded-full animate-spin mx-auto"></div>
                <p class="text-lg text-gray-200 mt-4">Generating your beautiful smile...</p>
            </div>
            <img id="final-image" src="" alt="A special smile" class="hidden rounded-2xl shadow-2xl max-w-full mx-auto">
        </div>

    </div>

    <!-- Audio Error Toast Removed -->


    <script type="module">
        // === 1. Three.js Scene Setup ===
        let scene, camera, renderer, particles; 
        
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // --- Particle System ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); // Soft white light
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xff69b4, 1, 100); // Pinkish point light
            pointLight.position.set(0, 0, 2);
            scene.add(pointLight);

            const particleCount = 5000;
            const vertices = [];
            for (let i = 0; i < particleCount; i++) {
                const x = (Math.random() - 0.5) * 20;
                const y = (Math.random() - 0.5) * 20;
                const z = (Math.random() - 0.5) * 20;
                vertices.push(x, y, z);
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            const material = new THREE.PointsMaterial({
                color: 0xff69b4, // Hot pink
                size: 0.02,
                transparent: true,
                blending: THREE.AdditiveBlending,
                opacity: 0.8
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.0001;
            if (particles) {
                particles.rotation.x = time * 0.2; // Gently rotate the particles
                particles.rotation.y = time * 0.5;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // === 2. Custom Music Setup (Reverted to Tone.js) ===
        let isMuted = false;
        // const audioEl = document.getElementById('bg-music'); // Removed
        const muteButton = document.getElementById('mute-button');
        const iconMuted = document.getElementById('icon-muted');
        const iconUnmuted = document.getElementById('icon-unmuted');

        // Removed handleAudioError function

        function initMusic() {
            // Create a synth and connect it to the main output (your speakers)
            const synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "fatsawtooth" }, // A soft, rich sound
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.4 },
                volume: -12 // Not too loud
            }).toDestination();
            
            // A simple, romantic chord progression
            const chords = [
                ["C4", "E4", "G4"], // C Major
                ["A3", "C4", "E4"], // A Minor
                ["F3", "A3", "C4"], // F Major
                ["G3", "B3", "D4"]  // G Major
            ];
            let chordIndex = 0;

            // Create a loop
            const loop = new Tone.Loop(time => {
                const chord = chords[chordIndex % chords.length];
                synth.triggerAttackRelease(chord, "1n", time); // Play chord for one measure
                chordIndex++;
            }, "1m").start(0); // Loop every 1 measure
            
            Tone.Transport.bpm.value = 70; // Set a slow, romantic tempo
            Tone.Transport.start();

            // Browser requires a user click to start audio
            document.body.addEventListener('click', async () => {
                await Tone.start();
                console.log("Audio context started");
            }, { once: true });
        }

        // === 3. App Logic ===
        const screens = document.querySelectorAll('.screen');
        const nameInput = document.getElementById('name-input');
        const nameSubmitBtn = document.getElementById('name-submit-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const chatContainer = document.getElementById('chat-container');
        const optionsContainer = document.getElementById('options-container');
        const nextQBtn = document.getElementById('next-q-btn');
        const exitBtn = document.getElementById('exit-btn');
        const hateInput = document.getElementById('hate-input');
        const hateReplyBtn = document.getElementById('hate-reply-btn');
        
        let currentQuestionIndex = 0;
        let userName = "";

        const questions = [
            { q: "Aapko kya pasand hai?", o: ["Mountain üèîÔ∏è", "Beach üèñÔ∏è"] },
            { q: "Aap kya prefer karengi?", o: ["Tea ‚òï", "Coffee üçµ"] },
            { q: "Kaisa mausam accha lagta hai?", o: ["Rain üåßÔ∏è", "Sunshine ‚òÄÔ∏è"] },
            { q: "Kaunsa furry friend?", o: ["Dog üê∂", "Cat üê±"] },
            { q: "Italian me kya pasand hai?", o: ["Pizza üçï", "Pasta üçù"] },
            { q: "Ek perfect date?", o: ["Long Drive üöó", "Candle Light Dinner üïØÔ∏è"] },
            { q: "How do you show love?", o: ["Hug ü§ó", "Kiss üòò"] },
            { q: "Binge-watch kya karein?", o: ["Movies üé¨", "Web Series üì∫"] },
            { q: "What's more important?", o: ["Love ‚ù§Ô∏è", "Friendship üíû"] },
            { q: "Raat me...?", o: ["Party ü•≥", "Cuddling ü•∞"] }
        ];

        function showScreen(screenId) {
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.remove('hidden', 'absolute');
                } else {
                    screen.classList.add('hidden', 'absolute');
                }
            });
            if (screenId === 'final-srk-screen') {
                startHeartAnimation();
            }
        }

        function scrollChatToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addChatMessage(text, sender = 'bot', delay = 0) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.classList.add('chat-bubble', sender === 'bot' ? 'chat-bot' : 'chat-user');
                    bubble.textContent = text;
                    chatContainer.appendChild(bubble);
                    scrollChatToBottom();
                    resolve();
                }, delay);
            });
        }
        
        function showTypingIndicator() {
            const typingBubble = document.createElement('div');
            typingBubble.id = 'typing-indicator';
            typingBubble.classList.add('chat-bubble', 'chat-bot', 'typing-indicator');
            typingBubble.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(typingBubble);
            scrollChatToBottom();
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function displayQuestion(index) {
            optionsContainer.innerHTML = ''; 
            
            if (index < questions.length) {
                const q = questions[index];
                addChatMessage(q.q, 'bot').then(() => {
                    q.o.forEach(optionText => {
                        const button = document.createElement('button');
                        button.className = "flex-1 bg-rose-600 text-white p-3 rounded-lg text-lg font-semibold hover:bg-rose-700 transition-colors";
                        button.textContent = optionText;
                        button.onclick = () => handleAnswer(optionText, q.q);
                        optionsContainer.appendChild(button);
                    });
                });
            } else {
                addChatMessage("That's all... ab ek final cheez...", 'bot', 500).then(() => {
                    setTimeout(() => showScreen('final-srk-screen'), 2000);
                });
            }
        }
        
        async function handleAnswer(answer, questionText) {
            optionsContainer.innerHTML = '<p class="text-center text-gray-400 w-full">Aapne select kar liya...</p>';
            
            await addChatMessage(answer, 'user', 100);
            showTypingIndicator();
            
            try {
                const reply = await getRomanticReply(questionText, answer);
                removeTypingIndicator();
                await addChatMessage(reply, 'bot', 300);
            } catch (error) {
                console.error("Error getting romantic reply:", error);
                removeTypingIndicator();
                await addChatMessage("Aapka choice itna accha hai ki mere paas alfaz nahi hain... üíñ", 'bot', 300);
            }
            
            setTimeout(() => {
                showScreen('transition-screen');
            }, 2000);
        }

        function handleNextQuestion() {
            currentQuestionIndex++;
            showScreen('qa-screen');
            displayQuestion(currentQuestionIndex);
        }

        function handleNameSubmit() {
            userName = nameInput.value.trim().toLowerCase();
            if (userName === 'yukta') {
                // Music will start on its own now due to the 'click' listener in initMusic
                // No need to call play() here
                
                showScreen('qa-screen');
                addChatMessage("Hello Yukta! üíñ Welcome...", 'bot').then(() => {
                    displayQuestion(currentQuestionIndex);
                });
            } else {
                showScreen('gatekeep-screen');
            }
        }
        
        function startHeartAnimation() {
            const container = document.getElementById('hearts-container');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const heart = document.createElement('div');
                heart.classList.add('heart');
                heart.textContent = '‚ù§Ô∏è';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDelay = `${Math.random() * 5}s`;
                heart.style.fontSize = `${Math.random() * 1 + 1}rem`;
                container.appendChild(heart);
            }
        }
        
        async function handleHateReply() {
            const reply = hateInput.value.trim().toLowerCase();
            if (reply === 'i hate u 2' || reply === 'i hate u ‚ôæÔ∏è' || reply === 'i hate u too') {
                showScreen('final-reply-screen');
                setTimeout(() => {
                    showScreen('final-image-screen');
                    generateFinalImage();
                }, 4000);
            } else {
                hateInput.value = '';
                hateInput.placeholder = "Try again... üòú";
                hateInput.classList.add('border-red-500', 'animate-pulse');
                setTimeout(() => {
                    hateInput.classList.remove('border-red-500', 'animate-pulse');
                    hateInput.placeholder = "Reply...";
                }, 2000);
            }
        }

        // === 4. Gemini API Calls ===
        
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API request failed with status:", response.status, "Body:", errorBody);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed: ${error.message}. Retrying in ${delay}ms...`);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        console.error("All retry attempts failed.");
                        throw error;
                    }
                }
            }
        }

        async function getRomanticReply(question, answer) {
            // *** API KEY IS INTENTIONALLY EMPTY ***
            // The environment securely provides the key.
            // Do NOT paste your key here.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = "You are a romantic poet, a mix of Shinchan's playful humor and SRK's deep romance. Your girlfriend, Yukta, is answering a 'this or that' question. Based on her answer, give a very short (1-2 lines), cute, and romantic reply in Hinglish. Be playful, loving, and a little cheesy. Example: If she chooses 'Tea', you could say 'Aapke saath ek cup chai peena... meri choti si khwahish hai üíñ'.";
            
            const userQuery = `The question was: "${question}". She chose: "${answer}". Give me a reply.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const result = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                return text.trim();
            } else {
                console.error("Invalid response from Gemini API:", result);
                throw new Error("Invalid response from Gemini API");
            }
        }

        async function generateFinalImage() {
            // *** API KEY IS INTENTIONALLY EMPTY ***
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

            const payload = {
                instances: { 
                    prompt: "A beautiful Indian girl smiling warmly, digital art style. She looks happy and content, with a kind expression. Soft, romantic, glowing lighting. Her smile is genuine and heartwarming." 
                },
                parameters: { "sampleCount": 1 }
            };

            try {
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    const imgElement = document.getElementById('final-image');
                    const loadingElement = document.getElementById('image-loading');
                    
                    imgElement.src = imageUrl;
                    imgElement.onload = () => {
                        loadingElement.classList.add('hidden');
                        imgElement.classList.remove('hidden');
                        imgElement.classList.add('animate-popIn'); 
                    };
                } else {
                    console.error("No image data in response:", result);
                    throw new Error("No image data in response.");
                }
            } catch (error) {
                console.error("Image generation failed:", error);
                const loadingElement = document.getElementById('image-loading');
                loadingElement.innerHTML = '<p class="text-red-400">Sorry, aapki smile capture nahi kar paya... but I know it\'s the best in the world ‚ù§Ô∏è</p>';
            }
        }

        // === 5. Initializers ===
        window.onload = () => {
            initThree();
            initMusic();
            
            // Setup event listeners
            nameSubmitBtn.addEventListener('click', handleNameSubmit);
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleNameSubmit();
            });
            
            tryAgainBtn.addEventListener('click', () => showScreen('name-prompt-screen'));
            nextQBtn.addEventListener('click', handleNextQuestion);
            exitBtn.addEventListener('click', () => showScreen('hate-you-screen'));
            hateReplyBtn.addEventListener('click', handleHateReply);
            hateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleHateReply();
            });

            muteButton.addEventListener('click', () => {
                if (muteButton.disabled) return;
                isMuted = !isMuted;
                if (isMuted) {
                    // audioEl.pause(); // Replaced
                    Tone.Master.mute = true;
                    iconMuted.classList.remove('hidden');
                    iconUnmuted.classList.add('hidden');
                } else {
                    // audioEl.play().catch(e => console.error("Audio play failed:", e)); // Replaced
                    Tone.Master.mute = false;
                    iconMuted.classList.add('hidden');
                    iconUnmuted.classList.remove('hidden');
                }
            });
            
            // Show the first screen
            showScreen('name-prompt-screen');
        };
    </script>
</body>
</html>
